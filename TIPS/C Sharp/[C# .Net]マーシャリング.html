<!DOCTYPE html>

<html lang="ja">
<!-- --------------------------------------
head
--------------------------------------- -->
<head>
<meta content="text/html" charset="utf-8" http-equiv="Content-Type" />

<!-- 基準URI -->
<base href="file:///G:/共有ドライブ/098-all-employees/tips/HTML_TIPS/">

<!-- スタイルシート -->
<link rel="stylesheet" href="_Assets/Sytle001.css" type="text/css">

<!-- スクリプト -->
<!-- タイトル表示 -->
<script src="_Assets/MakeTitle.js" type="text/javascript"></script>
<!-- 目次表示 -->
<script src="_Assets/MakeToc.js" type="text/javascript"></script>



</head>

<!-- --------------------------------------
body
--------------------------------------- -->
<body>
<!-- ページタイトル(ページ内表示) -->
<span id="title"></span>

<!-- 出典・関連ページ -->
<h5>関連 :</h5>
<a href="TIPS/C%20Sharp/[C%23%20.Net]C%23からC++の関数をコールする.html">[C# Net]C#からC++の関数をコールする</a><br>

<!-- 目次 -->
<h5>目次 :</h5>
<div id="toc"></div>

<hr>

<!-- 本文ここから -->


※ この文書は書きかけです。厳密には正しくありません。<br>
<br>

<h2>マーシャリングとは</h2>
C++とC#では型に互換性が無く、データをそのままの形式で渡すことができない場合が存在する。<br>
(例 : C++の string とC#の string は互換性が無い)<br>
このためデータの授受に当たっては、互換性のある形式に変換(マーシャリング)する必要がある。<br>
<br>

<h2>実装例</h2>
いずれも CPlusDLL.dll をロードするものとする。<br>
<h3>整数型</h3>
マーシャリングは不要。但し(ポインタによる)参照渡しの場合は ref / out 修飾が必要。<br>
ライブラリ(C++)<br>

<p class="code">
<keyword>#ifdef</keyword> __cplusplus
<keyword>#define</keyword> DLLEXPORT <keyword>extern</keyword> <literal>"<literal>C</literal>"</literal> __declspec(dllexport)
<keyword>#else</keyword>
<keyword>#define</keyword> DLLEXPORT __declspec(dllexport)
<keyword>#endif</keyword>

<comment>// 値渡し(int)</comment>
DLLEXPORT <keyword>int</keyword> __stdcall Mul(<keyword>int</keyword> x, <keyword>int</keyword> y)
{
    <keyword>return</keyword> x * y;
}

<comment>// 参照渡し(int*)</comment>
<comment>// ( result に結果を格納して返す)</comment>
DLLEXPORT <keyword>void</keyword> __stdcall MulUsePointer(<keyword>int</keyword> *x, <keyword>int</keyword> *y, <keyword>int</keyword> *result)
{
    *result = (*x) * (*y);
}
</p>

アプリケーション(C#)<br>

<p class="code">
using System;
using System.Runtime.InteropServices;

namespace ConsoleApp1
{
    <keyword>class</keyword> Program
    {
        <comment>// 値渡し</comment>
        [DllImport(<literal>"CPlusDLL"</literal>, EntryPoint = <literal>"Mul"</literal>)]
        <keyword>static</keyword> <keyword>extern</keyword> <keyword>int</keyword> _Mul(<keyword>int</keyword> x, <keyword>int</keyword> y);

        <comment>// 参照渡し</comment>
        <comment>// DLLへの入力は ref 、DLLからの出力は out (または ref )で修飾</comment>
        [DllImport(<literal>"CPlusDLL"</literal>, EntryPoint = <literal>"MulUsePointer"</literal>)]
        <keyword>static</keyword> <keyword>extern</keyword> <keyword>void</keyword> _MulUsePointer(ref <keyword>int</keyword> x, ref <keyword>int</keyword> y, out <keyword>int</keyword> result);

        <comment>// 実処理部</comment>
        <keyword>static</keyword> <keyword>void</keyword> Main(<keyword>string</keyword>[] args)
        {
            <keyword>int</keyword> x = <literal>10</literal>;
            <keyword>int</keyword> y = <literal>20</literal>;

            <keyword>int</keyword> resultMul = _Mul(x, y);
            Console.WriteLine(<literal>"Mul = "</literal> + resultMul);

            _MulUsePointer(ref x, ref y, out <keyword>int</keyword> resultMulUsePointer);
            Console.WriteLine(<literal>"MulUsePointer = "</literal> + resultMulUsePointer);
        }
     }
}
</p>

<h3>文字列</h3>
C++の string / wstring とC#の string には互換性が無いため、マーシャリングが必要。<br>
ライブラリ(C++)<br>

<p class="code">
<keyword>#include</keyword> &lt;<keyword>string</keyword>&gt;

<keyword>#ifdef</keyword> __cplusplus
<keyword>#define</keyword> DLLEXPORT <keyword>extern</keyword> <literal>"<literal>C</literal>"</literal> __declspec(dllexport)
<keyword>#else</keyword>
<keyword>#define</keyword> DLLEXPORT __declspec(dllexport)
<keyword>#endif</keyword>

<keyword>static</keyword> std::<keyword>string</keyword> _str = <literal>""</literal>;
<keyword>static</keyword> std::<keyword>wstring</keyword> _wstr = <literal>L""</literal>;

<comment>// マルチバイト文字列型</comment>
<comment>// (char* ⇒ string)</comment>
DLLEXPORT <keyword>void</keyword> __stdcall SetNameStr(<keyword>const</keyword> <keyword>char</keyword> *t)
{
    _str = std::<keyword>string</keyword>(t);
}

<comment>// (string ⇒ char*)</comment>
DLLEXPORT <keyword>const</keyword> <keyword>char</keyword> * __stdcall GetNameStr()
{
    <keyword>return</keyword> _str.c_str();
}

<comment>// ワイド文字列型</comment>
<comment>// (wchar_t* ⇒ wstring)</comment>
DLLEXPORT <keyword>void</keyword> __stdcall SetNameWStr(<keyword>const</keyword> <keyword>wchar_t</keyword> *t)
{
    _wstr = std::<keyword>wstring</keyword>(t);
}

<comment>// (wstring ⇒ wchar_t*)</comment>
DLLEXPORT <keyword>const</keyword> <keyword>wchar_t</keyword> * __stdcall GetNameWStr()
{
    <keyword>return</keyword> _wstr.c_str();
}
</p>

アプリケーション(C#)<br>

<p class="code">
using System;
using System.Runtime.InteropServices;

namespace ConsoleApp1
{
    <keyword>class</keyword> Program
    {
        <comment>// マルチバイト文字列型</comment>
        <comment>// CharSet = CharSet.Ansi</comment>
        [DllImport(<literal>"CPlusDLL"</literal>, EntryPoint = <literal>"SetNameStr"</literal>, CharSet = CharSet.Ansi)]
        <keyword>static</keyword> <keyword>extern</keyword> <keyword>void</keyword> _SetNameStr(<keyword>string</keyword> t);

        [DllImport(<literal>"CPlusDLL"</literal>, EntryPoint = <literal>"GetNameStr"</literal>, CharSet = CharSet.Ansi)]
        <keyword>static</keyword> <keyword>extern</keyword> IntPtr _GetNameStr();

        <comment>// ワイド文字列型</comment>
        <comment>// CharSet = CharSet.Unicode</comment>
        [DllImport(<literal>"CPlusDLL"</literal>, EntryPoint = <literal>"SetNameWStr"</literal>, CharSet = CharSet.Unicode)]
        <keyword>static</keyword> <keyword>extern</keyword> <keyword>void</keyword> _SetNameWStr(<keyword>string</keyword> t);

        [DllImport(<literal>"CPlusDLL"</literal>, EntryPoint = <literal>"GetNameWStr"</literal>, CharSet = CharSet.Unicode)]
        <keyword>static</keyword> <keyword>extern</keyword> IntPtr _GetNameWStr();

        <keyword>static</keyword> <keyword>void</keyword> Main(<keyword>string</keyword>[] args)
        {
            <keyword>string</keyword> testString = <literal>"東京都新宿 <literal>1</literal>-<literal>1</literal>"</literal>;
            _SetNameStr(testString);
            Console.WriteLine(<literal>"GetNameStr = "</literal> + Marshal.PtrToStringAnsi(_GetNameStr()));

            _SetNameWStr(testString);
            Console.WriteLine(<literal>"GetNameWStr = "</literal> + Marshal.PtrToStringUni(_GetNameWStr()));
        }
     }
}
</p>

<h3>配列</h3>
要マーシャリング。多次元配列を直接マーシャリングすることができない(要調査)ため、1次元配列に変換を行う。<br>
ライブラリ(C++)<br>

<p class="code">
<kwd>#ifdef</kwd> __cplusplus
<kwd>#define</kwd> DLLEXPORT <kwd>extern</kwd> <ltr>"<ltr>C</ltr>"</ltr> __declspec(dllexport)
<kwd>#else</kwd>
<kwd>#define</kwd> DLLEXPORT __declspec(dllexport)
<kwd>#endif</kwd>

DLLEXPORT <kwd>void</kwd> __stdcall SetArray(<kwd>const</kwd> <kwd>int</kwd>* arr)
{
    (略)
}
</p>
アプリケーション(C#)<br>
<p class="code">
using System;
using System.Runtime.InteropServices;

namespace ConsoleApp1
{
    <keyword>class</keyword> Program
    {
         [DllImport(<literal>"CPlusDLL"</literal>, EntryPoint = <literal>"SetArray"</literal>)]
        <keyword>static</keyword> <keyword>extern</keyword> <keyword>void</keyword> _SetArray(IntPtr arr);

        <keyword>static</keyword> <keyword>void</keyword> Main(<keyword>string</keyword>[] args)
        {
            <keyword>int</keyword>[,] matrix = new <keyword>int</keyword>[<literal>3</literal>, <literal>3</literal>]
            {
                {<literal>0</literal>, <literal>1</literal>, <literal>2</literal>},
                {<literal>3</literal>, <literal>4</literal>, <literal>5</literal>},
                {<literal>6</literal>, <literal>7</literal>, <literal>8</literal>},
            };

            <comment>// matrix をシリアライズ</comment>
            <keyword>int</keyword> arr[] = new <keyword>int</keyword>[<literal>3</literal>*<literal>3</literal>];
            <keyword>int</keyword> i = <literal>0</literal>;
            <keyword>for</keyword> (<keyword>int</keyword> y = <literal>0</literal>; y &lt; <literal>3</literal>; ++y)
            {
                <keyword>for</keyword> (<keyword>int</keyword> x = <literal>0</literal>; x &lt; <literal>3</literal>; ++x)
                {
                    arr[i] = matrix[y,x];
                    ++i;
                }
            }

            <comment>// データ授受用の IntPtr 生成( arr (matrix) の内容を格納する領域を確保</comment>
            IntPtr ptr =  Marshal.AllocHGlobal(Marshal.SizeOf(typeof(<keyword>int</keyword>)) * <literal>3</literal> * <literal>3</literal>)
 
            <comment>// arr の内容を ptr にコピー</comment>
            Marshal.Copy(arr, <literal>0</literal>, ptr, <literal>3</literal>*<literal>3</literal>);
 
            <comment>// DLL APIコール</comment>
            _SetArray(ptr);
 
            <comment>// ptr の内容を arr にコピー</comment>
            Marshal.Copy(ptr, arr, <literal>0</literal>, <literal>3</literal>*<literal>3</literal>);
 
            <comment>// 領域解放</comment>
            Marshal.FreeHGlobal(ptr);
        }
     }
}
</p>

<h3>構造体</h3>
書式指定[StructLayout(LayoutKind.Sequential)]、入力・出力マーシャリング指定[In][Out]の指定が必要。<br>
[In] : 入力方向(C# ⇒ C++)のマーシャリングを行う<br>
[Out] : 出力方向(C++ ⇒ C#)のマーシャリングを行う<br>
ライブラリ(C++)<br>
<p class="code">
<kwd>#ifdef</kwd> __cplusplus
<kwd>#define</kwd> DLLEXPORT <kwd>extern</kwd> <ltr>"<ltr>C</ltr>"</ltr> __declspec(dllexport)
<kwd>#else</kwd>
<kwd>#define</kwd> DLLEXPORT __declspec(dllexport)
<kwd>#endif</kwd>

<cmt>// 構造体定義</cmt>
<kwd>struct</kwd> stSample
{
    <kwd>int</kwd> a;
    <kwd>int</kwd> b;
};

<cmt>// DLLに構造体を渡す</cmt>
DLLEXPORT <kwd>void</kwd> __stdcall SetStruct(<kwd>const</kwd> stSample* st)
{
    (略)
}

<cmt>// DLLから構造体を受け取る</cmt>
DLLEXPORT <kwd>void</kwd> __stdcall GetStruct(stSample* st)
{
    (略)
}
</p>
アプリケーション(C#)<br>
<p class="code">
using System;
using System.Runtime.InteropServices;

namespace ConsoleApp1
{
    <comment>// 構造体定義</comment>
    <comment>// class として定義する点に注意(参照渡しとするため)</comment>
    [StructLayout(LayoutKind.Sequential)]
    <keyword>class</keyword> stSample
    {
        <keyword>int</keyword> a;
        <keyword>int</keyword> b;
    };

    <keyword>class</keyword> Program
    {
        <comment>// DLLに構造体を渡す</comment>
         [DllImport(<literal>"CPlusDLL"</literal>, EntryPoint = <literal>"_SetStruct"</literal>)]
        <keyword>static</keyword> <keyword>extern</keyword> <keyword>void</keyword> _SetStruct([In] stSample st);

        <comment>// DLLから構造体を受け取る</comment>
         [DllImport(<literal>"CPlusDLL"</literal>, EntryPoint = <literal>"_GetStruct"</literal>)]
        <keyword>static</keyword> <keyword>extern</keyword> <keyword>void</keyword> _GetStruct([Out] stSample st);

        <keyword>static</keyword> <keyword>void</keyword> Main(<keyword>string</keyword>[] args)
        {
            stSample st;

            <comment>// DLL APIコール</comment>
            _SetStruct(st);
            _GetStruct(st);
        }
     }
}
</p>
</body>
</html>

